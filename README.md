# vasilij-m_infra
vasilij-m Infra repository

### Подключение к *someinternalhost* одной командой:

ssh -J appuser@<bastion_public_ip> appuser@<someinternalhost_private_ip>

### Вариант подключения вида `ssh someinternalhost`:

В файл `~/.ssh/config` нужно добавить следующие строки:

```
Host bastion
    HostName <bastion_public_ip>
    User appuser
    IdentityFile <private_ssh_key_location_for_yacloud>
Host someinternalhost
    HostName someinternalhost
    ProxyJump bastion
    User appuser
```

### Pritunl-OVPN

```
bastion_IP = 178.154.254.98
someinternalhost_IP = 10.128.0.18
```

### cloud-testapp

```
testapp_IP = 178.154.201.109
testapp_port = 9292
```

**Команда для создания инстанса с запущенным приложением:**

```
yc compute instance create \
--name reddit-app \
--hostname reddit-app \
--memory=4 \
--create-boot-disk image-folder-id=standard-images,image-family=ubuntu-1604-lts,size=10GB \
--network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4 \
--metadata serial-port-enable=1 \
--metadata-from-file user-data=./metadata.yml
```

### ДЗ №7. Сборка образов VM при помощи Packer

**Выполнено:**
* Основное задание с параметризацией шаблона
* Доп. задание "Построение bake-образа" с запуском приложения с помощью systemd юнита
* Доп. задание "Автоматизация создания ВМ"

### ДЗ №8. Практика IaC с использованием Terraform

**Выполнено:**
1. Основное задание:
  * Виртуальная машина описана в `main.tf`
  * Выодные переменные описаны в `outputs.tf`
  * Входные переменные параметризированы в `variables.tf` и `terraform.tfvars`

2. Доп. задание:
  * Описан балансировщик в `lb.tf`
  * В `outputs.tf` добавлен IP адрес балансировщика
  * Описано создание двух экземляров виртуальных машин в `main.tf` через параметр `count`

### ДЗ №9. Принципы организации инфраструктурного кода и работа над инфраструктурой в команде на примере Terraform

**Выполнено:**
1. Основное задание:
  * Один большой файл `main.tf` разбит на модули
  * Инраструтура разделена на окружения `dev` и `prod`
  * Модули параметризованы

2. Доп. задание:
  * Добавлены provisioner'ы для деплоя приложения
  * Настроен экспорт переменной `DATABASE_URL` в инстанс с приложением для подключения к базе MongoDB
  * Отредактирован конфиг MongoDB на принятие запросов на локальный IP адрес в приватной сети Yandex Cloud
  * Доступ к приложению по внешнему IP адресу протестирован

### ДЗ №10. Управление конфигурацией. Основные DevOps инструменты. Знакомство с Ansible

**Выполнено:**
1. Основное задание:
  * Созданы два файла `inventory` в `txt` и `yml` форматах
  * Кофигурация ansible для проекта описана в файле `ansible.cfg`
  * Написан простой плейбук `clone.yml` по клонированию приложения из github а сервер

### ДЗ №11. Деплой и управление конфигурацией с Ansible

**Выполнено:**
1. Основное задание:
  * Один большой плейбук по конфигурации инфраструктуры разбит на три: `db.yml`, `app.yml`, `deploy.yml` - эти плейбуки импоритуются в плейбук `site.yml`
  * Bash-скрипты в провиженинге Packer'а заменены плейбуками `packer_app.yml` и `packer_db.yml`, созданы новые образы
2. Доп. задание:
  * Написан bash-скрипт `inventory.sh` для формирования динамического inventory, скрипт добавлен в `ansible.cfg` в качестве дефолтного inventory

**upd. 24.06:**

Написал скрипт для динамического инвентори на питоне, потому что предыдущий скрипт на баше умел работать с фиксированным количеством инстансов в яндекс облаке (2), и к тому же работать в баше с джейсонами - боль и страдание.

Для работы нового скрипта нужны переменные окружения `yandexPassportOauthToken` и `ycFolderId` (для удобства и секурности можно указать их экспорт в файле ~/.profile).

### ДЗ №12. Ansible: работа с ролями и окружениями

**Выполнено:**
1. Основное задание:
  * Таски, переменные, шаблоны, файлы и хендлеры вынесены из плейбуков в отдельные роли `app` и `db`.
  * Добавлена комьюнити-роль `jdauphant.nginx`
  * Добавлен плейбук по созданию юзеров `users.yml`, файл с переменными для него зашиврован с помощью ansible-vault
  * Созданы два окружения `prod` и `stage`
2. Доп. задание:
  * Для окружений `prod` и `stage` формируется динамическое инвентари с помощью скрипта `inventory.py`, скрипт прописан в качестве дефолтотного инвентари для обоих окружений.

### ДЗ №13. Разработка и тестирование Ansible ролей и плейбуков

**Выполнено:**
1. Основное задание:
  * Локальная разработка при помощи Vagrant, доработка ролей для провижининга в Vagrant. Вынесение тасок по установке пакетов и конфигурации сервисов из файла `main.yml` в каждой роли в отдельные файлы.
  * Тестирование роли `db` при помощи Molecule и Testinfra. Проверка наличия и состояния сервиса MongoDB. Проверка наличия файла конфигурации для MongoDB. Проверка наличия открытого порта 27017, на котором слушает MongoDB
  * Пересбора образов Packer с использованием ролей `db` и `app`
2. Доп. задание:
  * Конфигурация Vagrant для корректной работы проксирования приложения с помощью nginx

### ДЗ №20. Устройство Gitlab CI. Построение процесса непрерывной поставки

#### Выполнено:

**1. Основное задание:**
  * Выполнена инсталляция Gitlab в Docker (omnibus-установка) на виртульную машину в облаке YandexCloud:

  Виртуальная машина развернута с помощью Terraform (файлы Terraform находятся в `terraform/gitlab`)
  Написана роль для установки Docker. Роль находится в `ansible/roles/docker` и запускается плейбуком `ansible/playbooks/docker_install.yml`.

  * Описан пайплайн для сборки, тестирования и запуска приложения reddit с использованием статических и динамических окружений.


**2. Доп. задание:**
  * Автоматизация развёртывания GitLab:

  Написана роль для развёртывания GitLab в docker-контейнере (роль находится в `ansible/roles/gitlab-srv`)

  * Запуск reddit в контейнере:

  Сборка приложения описана в файле `.gitlab-ci.yml` в джобе `build_job`. В ней контейнер с приложением собирается с помощью `Docker-in-Docker`, затем готовый образ тегируется коротким хэшем коммита и пушится в DockerHub.

  Запуск приложения описан в джобе `deploy_reddit_app`. Так как в нашем распоряжении всего одна машина, на ней я поднял и зарегистрировал второй раннер с shell-экзекьютором. В джобе `deploy_reddit_app` описано создание docker сети `reddit`, а также запуск контейнера с базой MongoDB и контейнера с приложением, которое было собрано в джобе `build_job` (образ скачивается из DockerHub). Прилодение запускается в окружении, соответствующем названию ветки.

  * Автоматизация развёртывания GitLab Runner:

  Написал ansible роль, которая устанавливает один GitLab Runner в докере с docker экзекьютором и другой - непосредственно на хосте с shell экзекьютором. Затем данная роль выполняет регистрацию раннеров на GitLab. Роль находится в `gitlab-ci/gitlab-runner`. Она запускатеся плейбуком `ansible/playbooks/gitlab_deploy.yml`, плейбуку при запуске нужно передать переменную `gitlab_runner_register_token` с GitLab токеном для раннеров. Также данный плейбук запускает роль по установке docker.
