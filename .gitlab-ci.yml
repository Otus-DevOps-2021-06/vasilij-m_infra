image: ruby:2.4.2

stages:
  - build
  - test
  - review
  - stage
  - production

# services:
#   - name: mongo:latest
#     alias: mongod

variables:
  DATABASE_URL: 'mongod'

before_script:
  - cd reddit
  - bundle install

build_job:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - |
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" \
      > /kaniko/.docker/config.json

  script:
    - echo 'Building reddit app...'
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile \
      --destination ${CI_REGISTRY_IMAGE}:${APP_BRANCH}_${CI_COMMIT_SHORT_SHA}

    # docker build --tag ${CI_REGISTRY_IMAGE}:${APP_BRANCH}_${CI_COMMIT_SHORT_SHA} .

  # environment:
  #   name: branch/$CI_COMMIT_REF_NAME
  #   url: http://$CI_ENVIRONMENT_SLUG.example.com
  # only:
  #   - branches
  # except:
  #   - master

# test_unit_job:
#   stage: test
#   services:
#     - mongo:latest
#   script:
#     - ruby simpletest.rb

# test_integration_job:
#   stage: test
#   script:
#     - echo 'Testing 2'

# deploy_dev_job:
#   stage: review
#   script:
#     - echo 'Deploy'
#   environment:
#     name: dev
#     url: http://dev.example.com

# branch review:
#   stage: review
#   script: echo "Deploy to $CI_ENVIRONMENT_SLUG"
#   environment:
#     name: branch/$CI_COMMIT_REF_NAME
#     url: http://$CI_ENVIRONMENT_SLUG.example.com
#   only:
#     - branches
#   except:
#     - master

# staging:
#   stage: stage
#   when: manual
#   only:
#     - /^\d+\.\d+\.\d+/
#   script:
#     - echo 'Deploy'
#   environment:
#     name: beta
#     url: http://beta.example.com

# production:
#   stage: production
#   when: manual
#   only:
#     - /^\d+\.\d+\.\d+/
#   script:
#     - echo 'Deploy'
#   environment:
#     name: production
#     url: http://example.com
